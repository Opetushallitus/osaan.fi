sudo: required
language: clojure

addons:
  postgresql: '9.3'

services:
- postgresql

before_install:
- sudo apt-get install graphviz
- cd db

before_script:
- psql --file=../env/local/db-server/dev.sql

script:
- lein run 'postgresql://osaan_adm:osaan-adm@127.0.0.1:5432/osaan' -u osaan_user --clear -t
- cd ../app
- lein doc
- mkdir eastwood
- lein eastwood "{:out \"eastwood/osaan-warnings.txt\"}" || true
- cd ../db-docs
- generate-schemadocs.sh
- cd ..

deploy:
- provider: s3
  access_key_id: $ARTIFACTS_ID
  secret_access_key:
    secure: Nt6qZv1rAxrWCbkkP79LCTclvQJ5v2M+Ltr+FTaEK/ex7wySZZ9akoiHKQxFK3mVHN1ea+pZGOe2qraNNUAFsmJVC4azKWGd9HMGeTgIJKqMpjaRMVHRknKI5qlTYVxG50gpq8Li9l3/G3T5atvtf1lybGGCpNyIIfFF/1E0zvI=
  bucket: opetushallitus-docs
  local-dir: db-docs/schemadocs
  upload-dir: osaan
  acl: public_read
  skip_cleanup: true
  region: eu-west-1
- provider: s3
  access_key_id: $ARTIFACTS_ID
  secret_access_key:
    secure: Nt6qZv1rAxrWCbkkP79LCTclvQJ5v2M+Ltr+FTaEK/ex7wySZZ9akoiHKQxFK3mVHN1ea+pZGOe2qraNNUAFsmJVC4azKWGd9HMGeTgIJKqMpjaRMVHRknKI5qlTYVxG50gpq8Li9l3/G3T5atvtf1lybGGCpNyIIfFF/1E0zvI=
  bucket: opetushallitus-docs
  local-dir: app/doc
  upload-dir: osaan-doc
  acl: public_read
  skip_cleanup: true
  region: eu-west-1
- provider: s3
  access_key_id: $ARTIFACTS_ID
  secret_access_key:
    secure: Nt6qZv1rAxrWCbkkP79LCTclvQJ5v2M+Ltr+FTaEK/ex7wySZZ9akoiHKQxFK3mVHN1ea+pZGOe2qraNNUAFsmJVC4azKWGd9HMGeTgIJKqMpjaRMVHRknKI5qlTYVxG50gpq8Li9l3/G3T5atvtf1lybGGCpNyIIfFF/1E0zvI=
  bucket: opetushallitus-docs
  local-dir: app/eastwood
  upload-dir: osaan-lint
  acl: public_read
  skip_cleanup: true
  region: eu-west-1
					